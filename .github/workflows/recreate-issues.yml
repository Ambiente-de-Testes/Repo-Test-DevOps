name: Recreate Issues on Target Repo

on:
  issues:
    types: [labeled]

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'labeled'

    steps:
      - name: Extract data
        id: extract
        run: |
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Determine target repo from label
        id: target
        run: |
          echo "Detectando label..."
          LABEL_NAME="${{ github.event.label.name }}"
          
          if [ -z "$LABEL_NAME" ]; then
            echo "Nenhuma label no evento direto, tentando pegar a primeira label da issue..."
            LABEL_NAME=$(echo "${{ github.event.issue.labels[0].name }}" | tr -d '[:space:]')
          fi

          if [ -z "$LABEL_NAME" ]; then
            echo "Nenhuma label encontrada. Encerrando."
            exit 1
          fi

          # üîç Ignorar labels espec√≠ficas
          if [ "$LABEL_NAME" = "Aprovado" ] || [ "$LABEL_NAME" = "Revis√£o Necess√°ria" ]; then
            echo "‚ö†Ô∏è Label '$LABEL_NAME' ignorada ‚Äî n√£o √© label de cria√ß√£o de reposit√≥rio."
            exit 0
          fi

          echo "repo=$LABEL_NAME" >> $GITHUB_OUTPUT
          echo "Reposit√≥rio alvo: $LABEL_NAME"

      - name: Create issue in target repository
        if: steps.target.outputs.repo != '' # s√≥ executa se repo tiver valor
        run: |
          echo "Criando issue em Ambiente-de-Testes/${{ steps.target.outputs.repo }}..."
          RESPONSE=$(curl -s -o response.json -w "%{http_code}" -X POST \
            -H "Authorization: token ${{ secrets.DEVOPS_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/Ambiente-de-Testes/${{ steps.target.outputs.repo }}/issues \
            -d @- <<EOF
          {
            "title": "${{ steps.extract.outputs.title }}",
            "body": "${{ steps.extract.outputs.body }}\n\n---\n_Origin: https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}_"
          }
          EOF
          )

          echo "C√≥digo de resposta: $RESPONSE"
          cat response.json
          if [ "$RESPONSE" -ne 201 ]; then
            echo "‚ùå Falha ao criar a issue."
            exit 1
          else
            echo "‚úÖ Issue criada com sucesso!"
          fi
