name: Atualizar "Status-Teste" e notificar responsÃ¡veis

on:
  issues:
    types: [labeled]

jobs:
  update-project-field:
    runs-on: ubuntu-latest
    steps:
      - name: Atualizar Status-Teste e notificar
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEVOPS_TOKEN }}
          script: |
            const projectId = "PVT_kwDODixzhM4BFb_a"; //
            const statusTesteFieldId = "PVTSSF_lADODixzhM4BFb_azg27a1U"; // "Status-Teste"
            const statusFieldId = "PVTSSF_lADODixzhM4BFb_azg2xh6E"; // 

            // IDs das opÃ§Ãµes, obtenha sempre pelo GraphQL!
            const aprovadoOption = "99129982";
            const revisaoOption = "f46e9ce7";
            const emDesenvolvimentoOption = "823324b0"; // Exemplo, atualize para sua opÃ§Ã£o

            const issue = context.payload.issue;
            const label = context.payload.label.name;
            const issueId = issue.node_id;
            const issueNumber = issue.number;
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            let optionId, message, statusOptionId;
            if (label === "Aprovado") {
              optionId = aprovadoOption;
              message = "âœ… AlteraÃ§Ã£o aprovada! Bom trabalho! ğŸ‰";
            } else if (label === "RevisÃ£o NecessÃ¡ria") {
              optionId = revisaoOption;
              message = "ğŸ” RevisÃ£o necessÃ¡ria â€” retornando para desenvolvimento.";
              statusOptionId = emDesenvolvimentoOption;
            } else {
              console.log("Label ignorada.");
              return;
            }

            // Busca o item do projeto (com paginaÃ§Ã£o)
            let items = [];
            let cursor = null;
            let hasNextPage = true;
            while (hasNextPage) {
              const query = await github.graphql(`
                query($projectId: ID!, $after: String) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100, after: $after) {
                        pageInfo { hasNextPage endCursor }
                        nodes { id content { ... on Issue { id } } }
                      }
                    }
                  }
                }
              `, { projectId, after: cursor });
              const pageItems = query.node.items.nodes;
              items = items.concat(pageItems);
              hasNextPage = query.node.items.pageInfo.hasNextPage;
              cursor = query.node.items.pageInfo.endCursor;
            }

            const item = items.find(i => i.content?.id === issueId);
            if (!item) {
              console.log("âš ï¸ Issue nÃ£o estÃ¡ no projeto.");
              return;
            }

            // Atualiza o campo "Status-Teste"
            try {
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item { id }
                  }
                }
              `, {
                projectId,
                itemId: item.id,
                fieldId: statusTesteFieldId,
                optionId
              });
              console.log(`âœ… Campo "Status-Teste" atualizado para opÃ§Ã£o ${optionId}`);
            } catch (error) {
              console.error("âŒ Erro ao atualizar Status-Teste:", error.message);
            }

            // Se houver campo Status, tambÃ©m altera para "Em Desenvolvimento"
            if (statusOptionId) {
              try {
                await github.graphql(`
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId,
                      itemId: $itemId,
                      fieldId: $fieldId,
                      value: { singleSelectOptionId: $optionId }
                    }) {
                      projectV2Item { id }
                    }
                  }
                `, {
                  projectId,
                  itemId: item.id,
                  fieldId: statusFieldId,
                  optionId: statusOptionId
                });
                console.log(`âœ… Campo "Status" atualizado para opÃ§Ã£o ${statusOptionId}`);
              } catch (error) {
                console.error("âŒ Erro ao atualizar Status:", error.message);
              }
            }

            // Notifica os responsÃ¡veis
            const assignees = (issue.assignees || []).map(a => `@${a.login}`).join(' ');
            const notify = assignees.length > 0 ? `\n\nğŸ‘¥ Notificando: ${assignees}` : '';

            // Cria o comentÃ¡rio
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: `${message}${notify}`
              });
              console.log(`ğŸ’¬ ComentÃ¡rio adicionado na issue`);
            } catch (error) {
              console.error("âŒ Erro ao comentar:", error.message);
            }

            console.log(`âœ… Workflow finalizado para label: ${label}`);
