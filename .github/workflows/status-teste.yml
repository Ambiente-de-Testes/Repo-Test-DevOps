name: Atualizar status e notificar responsÃ¡veis

on:
  issues:
    types: [labeled]

jobs:
  update-project-field:
    runs-on: ubuntu-latest
    steps:
      - name: Atualizar Status e notificar
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEVOPS_TOKEN }}
          script: |
            const projectId = "PVT_kwDODixzhM4BFb_a"; //
            const statusFieldId = "PVTSSF_lADODixzhM4BFb_azg2xh6E"; //
            const emDesenvolvimentoOption = "823324b0"; // 

            const issue = context.payload.issue;
            const label = context.payload.label.name;
            const issueId = issue.node_id;
            const issueNumber = issue.number;
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            let statusOptionId, message;
            if (label === "Aprovado") {
              message = "âœ… AlteraÃ§Ã£o aprovada! Bom trabalho! ğŸ‰";
              // Se quiser mudar status, defina o id aqui
              // statusOptionId = "ID_OPCAO_APROVADO";
            } else if (label === "RevisÃ£o necessÃ¡ria") {
              message = "ğŸ” RevisÃ£o necessÃ¡ria â€” retornando para desenvolvimento.";
              statusOptionId = emDesenvolvimentoOption;
            } else {
              console.log("Label ignorada.");
              return;
            }

            // Busca o item do projeto (com paginaÃ§Ã£o)
            let items = [];
            let cursor = null;
            let hasNextPage = true;
            while (hasNextPage) {
              const query = await github.graphql(`
                query($projectId: ID!, $after: String) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100, after: $after) {
                        pageInfo { hasNextPage endCursor }
                        nodes { id content { ... on Issue { id } } }
                      }
                    }
                  }
                }
              `, { projectId, after: cursor });
              const pageItems = query.node.items.nodes;
              items = items.concat(pageItems);
              hasNextPage = query.node.items.pageInfo.hasNextPage;
              cursor = query.node.items.pageInfo.endCursor;
            }

            const item = items.find(i => i.content?.id === issueId);
            if (!item) {
              console.log("âš ï¸ Issue nÃ£o estÃ¡ no projeto.");
              return;
            }

            // Se houver campo Status, tambÃ©m altera para "Em Desenvolvimento"
            if (statusOptionId) {
              try {
                await github.graphql(`
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId,
                      itemId: $itemId,
                      fieldId: $fieldId,
                      value: { singleSelectOptionId: $optionId }
                    }) {
                      projectV2Item { id }
                    }
                  }
                `, {
                  projectId,
                  itemId: item.id,
                  fieldId: statusFieldId,
                  optionId: statusOptionId
                });
                console.log(`âœ… Campo "Status" atualizado para opÃ§Ã£o ${statusOptionId}`);
              } catch (error) {
                console.error("âŒ Erro ao atualizar Status:", error.message);
              }
            }

            // Notifica os responsÃ¡veis (GitHub envia email se estiverem com notificaÃ§Ã£o ativada)
            const assignees = (issue.assignees || []).map(a => `@${a.login}`).join(' ');
            const notify = assignees.length > 0 ? `\n\nğŸ‘¥ Notificando: ${assignees}` : '';

            // Cria o comentÃ¡rio
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: `${message}${notify}`
              });
              console.log(`ğŸ’¬ ComentÃ¡rio adicionado na issue`);
            } catch (error) {
              console.error("âŒ Erro ao comentar:", error.message);
            }

            console.log(`âœ… Workflow finalizado para label: ${label}`);
