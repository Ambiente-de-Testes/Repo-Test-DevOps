name: Move Issue to Development

on:
  create:

jobs:
  update-project:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest

    steps:
      - name: Extract issue number from branch name
        id: extract
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "ğŸŒ¿ Branch criada: $BRANCH_NAME"
          echo "ğŸ“‚ RepositÃ³rio: ${{ github.repository }}"
          
          ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+' | head -1)
          
          if [ -n "$ISSUE_NUM" ]; then
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "âœ… NÃºmero extraÃ­do: #$ISSUE_NUM"
          else
            echo "âš ï¸ Nenhum nÃºmero de issue encontrado no nome da branch"
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

      - name: Update Project Status
        if: steps.extract.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEVSTATUS_TOKEN }}
          script: |
            try {
              const projectId = "PVT_kwDODixzhM4BFb_a";
              const statusFieldId = "PVTSSF_lADODixzhM4BFb_azg2xh6E";
              const STATUS_EM_DESENVOLVIMENTO = "823324b0";

              const issueNumber = ${{ steps.extract.outputs.issue_number }};
              const branchName = context.ref.replace('refs/heads/', '');
              const branchRepo = context.repo.owner + '/' + context.repo.repo;

              console.log(`ğŸŒ¿ Branch criada: ${branchName}`);
              console.log(`ğŸ“‚ RepositÃ³rio da branch: ${branchRepo}`);
              console.log(`ğŸ” Procurando issue #${issueNumber}...`);

              const reposToSearch = [
                { owner: 'Ambiente-de-Testes', repo: 'Repo-Test-DevOps' },
                { owner: context.repo.owner, repo: context.repo.repo }
              ];

              const uniqueRepos = reposToSearch.filter(
                (repo, index, self) =>
                  index === self.findIndex(r => r.owner === repo.owner && r.repo === repo.repo)
              );

              let issue = null;
              let issueOwner = null;
              let issueRepo = null;

              // ğŸ” Procura a issue
              for (const repo of uniqueRepos) {
                try {
                  console.log(`   Tentando ${repo.owner}/${repo.repo}...`);
                  const { data: foundIssue } = await github.rest.issues.get({
                    owner: repo.owner,
                    repo: repo.repo,
                    issue_number: issueNumber
                  });
                  issue = foundIssue;
                  issueOwner = repo.owner;
                  issueRepo = repo.repo;
                  console.log(`âœ… Issue encontrada em ${issueOwner}/${issueRepo}!`);
                  console.log(`   TÃ­tulo: "${issue.title}"`);
                  console.log(`   URL: ${issue.html_url}`);
                  break;
                } catch (err) {
                  if (err.status === 404) {
                    console.log(`   âŒ NÃ£o encontrada em ${repo.owner}/${repo.repo}`);
                  } else {
                    throw err;
                  }
                }
              }

              if (!issue) {
                console.log(`âš ï¸ Issue #${issueNumber} nÃ£o encontrada em nenhum repositÃ³rio`);
                return;
              }

              const issueNodeId = issue.node_id;

              // ğŸ“Š Busca o projeto
              console.log(`ğŸ“Š Buscando itens do projeto...`);
              const projectQuery = `
                query ($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      title
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue { 
                              id 
                              number 
                              title
                              repository { nameWithOwner }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const projectData = await github.graphql(projectQuery, { projectId });
              const items = projectData.node.items.nodes;
              console.log(`ğŸ“‹ Projeto: ${projectData.node.title}`);
              console.log(`ğŸ“‹ Total de itens: ${items.length}`);

              const projectItem = items.find(i => i.content?.id === issueNodeId);

              if (!projectItem) {
                console.log(`âš ï¸ Issue #${issueNumber} nÃ£o estÃ¡ no projeto`);
                console.log(`   Adicione a issue ao projeto primeiro: ${issue.html_url}`);
                return;
              }

              console.log(`âœ… Item encontrado no projeto`);
              console.log(`ğŸ”„ Atualizando status para "Em Desenvolvimento"...`);

              const updateMutation = `
                mutation ($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $value }
                  }) {
                    projectV2Item { id }
                  }
                }
              `;
              
              await github.graphql(updateMutation, {
                projectId,
                itemId: projectItem.id,
                fieldId: statusFieldId,
                value: STATUS_EM_DESENVOLVIMENTO
              });
              
              console.log(`ğŸ‰ Sucesso!`);
              console.log(`   Issue #${issueNumber} (${issueOwner}/${issueRepo}) â†’ "Em Desenvolvimento"`);
              console.log(`   Trigger: Branch "${branchName}" criada em ${branchRepo}`);
              
              // ğŸ’¬ Comenta na issue
              let commentBody =
                branchRepo === `${issueOwner}/${issueRepo}`
                  ? `ğŸŒ¿ Branch \`${branchName}\` criada\n\nâœ… Status atualizado para **Em Desenvolvimento**`
                  : `ğŸŒ¿ Branch \`${branchName}\` criada em **${branchRepo}**\n\nâœ… Status atualizado para **Em Desenvolvimento**`;

              if (issue.assignees && issue.assignees.length > 0) {
                const mentions = issue.assignees.map(a => `@${a.login}`).join(' ');
                commentBody += `\n\nğŸ‘¥ Notificando responsÃ¡veis: ${mentions}`;
              } else {
                commentBody += `\n\nğŸ‘¥ (Sem responsÃ¡veis atribuÃ­dos)`;
              }

              await github.rest.issues.createComment({
                owner: issueOwner,
                repo: issueRepo,
                issue_number: issueNumber,
                body: commentBody
              });

              console.log(`ğŸ’¬ ComentÃ¡rio adicionado na issue com menÃ§Ãµes aos responsÃ¡veis`);
            } catch (error) {
              console.error("ğŸš¨ Erro inesperado:", error);
              core.setFailed(`Erro ao mover issue: ${error.message}`);
            }
